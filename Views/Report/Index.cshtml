@{
    ViewBag.Title = "Report - Bike Store Management";
}

<!-- Include Chart.js CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<!-- Include TinyMCE for Bonus Feature -->
<script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>

<div class="container mt-4">
    <h1 class="text-center mb-4">Sales Reports & Analytics</h1>

    <!-- Report Section -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">Top 10 Most Popular Products</h3>
                </div>
                <div class="card-body" id="reportContent">
                    <div class="row">
                        <div class="col-md-8">
                            <canvas id="popularProductsChart"></canvas>
                        </div>
                        <div class="col-md-4">
                            <h5>Report Summary</h5>
                            <p>This report shows the top 10 most frequently ordered bicycle products based on order history.</p>
                            <p><strong>Purpose:</strong> Helps identify which products are most popular with customers, informing inventory and marketing decisions.</p>
                            <div class="mt-4">
                                <h6>Save Report</h6>
                                <div class="mb-3">
                                    <label class="form-label">File Name</label>
                                    <input type="text" id="reportFileName" class="form-control" placeholder="Enter file name" value="PopularProducts_Report">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">File Type</label>
                                    <select id="reportFileType" class="form-select">
                                        <option value="html">HTML</option>
                                        <option value="txt">Text</option>
                                    </select>
                                </div>
                                <button type="button" id="saveReportBtn" class="btn btn-success w-100">
                                    <i class="fas fa-save"></i> Save Report
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Additional Reports -->
    <div class="row mb-5">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h4 class="mb-0">Sales by Brand</h4>
                </div>
                <div class="card-body">
                    <canvas id="salesByBrandChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h4 class="mb-0">Top Customers</h4>
                </div>
                <div class="card-body">
                    <canvas id="topCustomersChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Document Archive Section -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h3 class="mb-0">Document Archive</h3>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>File Name</th>
                                    <th>Size</th>
                                    <th>Created Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (ViewBag.SavedFiles != null && ViewBag.SavedFiles.Count > 0)
                                {
                                    foreach (var file in ViewBag.SavedFiles)
                                    {
                                        <tr>
                                            <td>@file.FileName</td>
                                            <td>@((file.FileSize / 1024.0).ToString("F2")) KB</td>
                                            <td>@file.CreatedDate.ToString("yyyy-MM-dd HH:mm:ss")</td>
                                            <td>
                                                <button class="btn btn-sm btn-primary download-file" data-filename="@file.FileName">
                                                    <i class="fas fa-download"></i> Download
                                                </button>
                                                <button class="btn btn-sm btn-info view-description" data-filename="@file.FileName">
                                                    <i class="fas fa-eye"></i> View Description
                                                </button>
                                                <button class="btn btn-sm btn-danger delete-file" data-filename="@file.FileName">
                                                    <i class="fas fa-trash"></i> Delete
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="4" class="text-center">No saved reports</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Save with Description Modal (BONUS FEATURE) -->
<div class="modal fade" id="saveDescriptionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Report Description (Bonus Feature)</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Add a detailed description for this report:</p>
                <textarea id="reportDescription"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="confirmSaveBtn" class="btn btn-primary">Save with Description</button>
            </div>
        </div>
    </div>
</div>

<!-- View Description Modal -->
<div class="modal fade" id="viewDescriptionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Report Description</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="descriptionContent"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        var reportData = @Html.Raw(ViewBag.ReportData);
        var popularProductsChart, salesByBrandChart, topCustomersChart;

        $(document).ready(function () {
            // Initialize TinyMCE for Bonus Feature
            tinymce.init({
                selector: '#reportDescription',
                height: 300,
                menubar: false,
                plugins: 'lists link image table code',
                toolbar: 'undo redo | formatselect | bold italic | alignleft aligncenter alignright | bullist numlist | link image | code'
            });

            // Create Popular Products Chart
            var ctx1 = document.getElementById('popularProductsChart').getContext('2d');
            popularProductsChart = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: reportData.map(item => item.Label),
                    datasets: [{
                        label: 'Number of Orders',
                        data: reportData.map(item => item.Value),
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        title: {
                            display: true,
                            text: 'Top 10 Most Ordered Products'
                        }
                    }
                }
            });

            // Load Sales by Brand Chart
            $.get('@Url.Action("GetSalesReport", "Report")', function (data) {
                var ctx2 = document.getElementById('salesByBrandChart').getContext('2d');
                salesByBrandChart = new Chart(ctx2, {
                    type: 'pie',
                    data: {
                        labels: data.map(item => item.Brand),
                        datasets: [{
                            label: 'Total Sales ($)',
                            data: data.map(item => item.TotalSales),
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.6)',
                                'rgba(54, 162, 235, 0.6)',
                                'rgba(255, 206, 86, 0.6)',
                                'rgba(75, 192, 192, 0.6)',
                                'rgba(153, 102, 255, 0.6)',
                                'rgba(255, 159, 64, 0.6)',
                                'rgba(199, 199, 199, 0.6)',
                                'rgba(83, 102, 255, 0.6)',
                                'rgba(255, 99, 255, 0.6)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            });

            // Load Top Customers Chart
            $.get('@Url.Action("GetCustomerReport", "Report")', function (data) {
                var ctx3 = document.getElementById('topCustomersChart').getContext('2d');
                topCustomersChart = new Chart(ctx3, {
                    type: 'doughnut',
                    data: {
                        labels: data.map(item => item.CustomerName),
                        datasets: [{
                            label: 'Number of Orders',
                            data: data.map(item => item.OrderCount),
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.6)',
                                'rgba(54, 162, 235, 0.6)',
                                'rgba(255, 206, 86, 0.6)',
                                'rgba(75, 192, 192, 0.6)',
                                'rgba(153, 102, 255, 0.6)',
                                'rgba(255, 159, 64, 0.6)',
                                'rgba(199, 199, 199, 0.6)',
                                'rgba(83, 102, 255, 0.6)',
                                'rgba(255, 99, 255, 0.6)',
                                'rgba(100, 200, 100, 0.6)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            });

            // Save Report Button - Show Modal for Description (Bonus)
            $('#saveReportBtn').click(function () {
                $('#saveDescriptionModal').modal('show');
            });

            // Confirm Save with Description
            $('#confirmSaveBtn').click(function () {
                var fileName = $('#reportFileName').val() || 'Report';
                var fileType = $('#reportFileType').val();
                var description = tinymce.get('reportDescription').getContent();

                // Get report HTML content
                var reportHtml = '<html><head><title>' + fileName + '</title></head><body>';
                reportHtml += '<h1>Bike Store Sales Report</h1>';
                reportHtml += '<h2>Popular Products</h2>';
                reportHtml += '<table border="1" cellpadding="5">';
                reportHtml += '<tr><th>Product Name</th><th>Brand</th><th>Category</th><th>Orders</th></tr>';

                reportData.forEach(function(item) {
                    reportHtml += '<tr>';
                    reportHtml += '<td>' + item.Label + '</td>';
                    reportHtml += '<td>' + (item.Brand || 'N/A') + '</td>';
                    reportHtml += '<td>' + (item.Category || 'N/A') + '</td>';
                    reportHtml += '<td>' + item.Value + '</td>';
                    reportHtml += '</tr>';
                });

                reportHtml += '</table>';
                reportHtml += '<p>Report generated on: ' + new Date().toLocaleString() + '</p>';
                reportHtml += '</body></html>';

                $.ajax({
                    url: '@Url.Action("SaveReport", "Report")',
                    type: 'POST',
                    data: {
                        fileName: fileName,
                        fileType: fileType,
                        reportHtml: reportHtml,
                        description: description
                    },
                    success: function (response) {
                        if (response.success) {
                            alert(response.message);
                            $('#saveDescriptionModal').modal('hide');
                            location.reload();
                        } else {
                            alert(response.message);
                        }
                    }
                });
            });

            // Download File
            $('.download-file').click(function () {
                var fileName = $(this).data('filename');
                window.location.href = '@Url.Action("DownloadFile", "Report")' + '?fileName=' + fileName;
            });

            // View Description
            $('.view-description').click(function () {
                var fileName = $(this).data('filename');
                $.get('@Url.Action("GetFileDescription", "Report")', { fileName: fileName }, function (response) {
                    if (response.success) {
                        if (response.description) {
                            $('#descriptionContent').html(response.description);
                        } else {
                            $('#descriptionContent').html('<p class="text-muted">No description available for this report.</p>');
                        }
                        $('#viewDescriptionModal').modal('show');
                    }
                });
            });

            // Delete File
            $('.delete-file').click(function () {
                if (confirm('Are you sure you want to delete this file?')) {
                    var fileName = $(this).data('filename');
                    $.ajax({
                        url: '@Url.Action("DeleteFile", "Report")',
                        type: 'POST',
                        data: { fileName: fileName },
                        success: function (response) {
                            if (response.success) {
                                alert(response.message);
                                location.reload();
                            } else {
                                alert(response.message);
                            }
                        }
                    });
                }
            });
        });
    </script>
}