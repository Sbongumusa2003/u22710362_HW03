@{
    ViewBag.Title = "Report - Bike Store Management";
}

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.70/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.70/vfs_fonts.js"></script>

<style>
    .report-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    .report-section {
        border: 2px solid #ccc;
        padding: 20px;
        margin-bottom: 20px;
        background-color: #f9f9f9;
    }

    .report-header {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 30px;
        background-color: #e0e0e0;
        border: 2px solid #999;
        margin-bottom: 20px;
    }

    .report-icon {
        width: 120px;
        height: 120px;
        border: 2px solid #666;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: white;
    }

    .save-options {
        display: flex;
        gap: 15px;
        align-items: center;
        margin-top: 15px;
    }

        .save-options input,
        .save-options select {
            padding: 8px;
            border: 1px solid #999;
        }

    .archive-section {
        margin-top: 30px;
    }

    .archive-list {
        border: 2px solid #ccc;
        padding: 15px;
        background-color: #f5f5f5;
        min-height: 200px;
    }

    .archive-item {
        padding: 10px;
        background-color: white;
        margin-bottom: 10px;
        border: 1px solid #ddd;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
</style>

<div class="report-container">
    <h2>Report</h2>

    <!-- Report Display Section -->
    <div class="report-section">
        <div class="report-header">
            <div class="report-icon">
                <div style="text-align: center;">
                    <div style="font-size: 10px; margin-bottom: 5px;">📊</div>
                    <div style="font-size: 8px;">━━━</div>
                    <div style="font-size: 8px;">━━━</div>
                    <div style="font-size: 10px; margin-top: 5px;">⊙</div>
                </div>
            </div>
        </div>

        <div class="save-options">
            <input type="text" id="reportFileName" placeholder="Filename" style="flex: 1;">
            <input type="text" id="reportFileType" placeholder="File Type" style="flex: 1;">
            <button type="button" id="saveReportBtn" class="btn btn-secondary">Save</button>
        </div>

        <!-- Chart Container -->
        <div style="margin-top: 30px; padding: 20px; background-color: white; border: 1px solid #ddd;">
            <canvas id="reportChart" width="800" height="400"></canvas>
        </div>
    </div>

    <!-- Archive Section -->
    <div class="archive-section">
        <h3>Archive</h3>
        <div class="archive-list" id="archiveList">
            @if (ViewBag.SavedFiles != null && ViewBag.SavedFiles.Count > 0)
            {
                foreach (var file in ViewBag.SavedFiles)
                {
                    <div class="archive-item">
                        <div>
                            <strong>@file.FileName</strong>
                            <span style="margin-left: 20px; color: #666;">@((file.FileSize / 1024.0).ToString("F2")) KB</span>
                            <span style="margin-left: 20px; color: #666;">@file.CreatedDate.ToString("yyyy-MM-dd HH:mm")</span>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-primary download-file" data-filename="@file.FileName">Download</button>
                            <button class="btn btn-sm btn-danger delete-file" data-filename="@file.FileName">Delete</button>
                        </div>
                    </div>
                }
            }
            else
            {
                <div style="text-align: center; padding: 40px; color: #999;">
                    <div style="font-size: 12px; margin-bottom: 10px;">━━━━━━━━━━━</div>
                    <div style="font-size: 12px; margin-bottom: 10px;">━━━━━━━</div>
                    <div style="font-size: 12px;">━━━━━━━</div>
                    <p style="margin-top: 20px;">No saved reports</p>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        var reportData = @Html.Raw(ViewBag.ReportData);
        var reportChart;

        $(document).ready(function () {
            // Create Report Chart
            var ctx = document.getElementById('reportChart').getContext('2d');
            reportChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: reportData.map(item => item.Label),
                    datasets: [{
                        label: 'Number of Orders',
                        data: reportData.map(item => item.Value),
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        yAxes: [{
                            ticks: {
                                beginAtZero: true,
                                stepSize: 1
                            }
                        }]
                    },
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    title: {
                        display: true,
                        text: 'Top 10 Most Popular Products'
                    }
                }
            });

            // Save Report
            $('#saveReportBtn').click(function () {
                var fileName = $('#reportFileName').val() || 'Report';
                var fileType = $('#reportFileType').val() || 'html';

                var reportHtml = '<html><head><title>' + fileName + '</title></head><body>';
                reportHtml += '<h1>Bike Store Sales Report</h1>';
                reportHtml += '<h2>Popular Products</h2>';
                reportHtml += '<table border="1" cellpadding="5">';
                reportHtml += '<tr><th>Product Name</th><th>Brand</th><th>Category</th><th>Orders</th></tr>';

                reportData.forEach(function(item) {
                    reportHtml += '<tr>';
                    reportHtml += '<td>' + item.Label + '</td>';
                    reportHtml += '<td>' + (item.Brand || 'N/A') + '</td>';
                    reportHtml += '<td>' + (item.Category || 'N/A') + '</td>';
                    reportHtml += '<td>' + item.Value + '</td>';
                    reportHtml += '</tr>';
                });

                reportHtml += '</table>';
                reportHtml += '<p>Report generated on: ' + new Date().toLocaleString() + '</p>';
                reportHtml += '</body></html>';

                $.ajax({
                    url: '@Url.Action("SaveReport", "Report")',
                    type: 'POST',
                    data: {
                        fileName: fileName,
                        fileType: fileType,
                        reportHtml: reportHtml
                    },
                    success: function (response) {
                        if (response.success) {
                            alert(response.message);
                            location.reload();
                        } else {
                            alert(response.message);
                        }
                    }
                });
            });

            // Download File
            $('.download-file').click(function () {
                var fileName = $(this).data('filename');
                window.location.href = '@Url.Action("DownloadFile", "Report")' + '?fileName=' + fileName;
            });

            // Delete File
            $('.delete-file').click(function () {
                if (confirm('Are you sure you want to delete this file?')) {
                    var fileName = $(this).data('filename');
                    $.ajax({
                        url: '@Url.Action("DeleteFile", "Report")',
                        type: 'POST',
                        data: { fileName: fileName },
                        success: function (response) {
                            if (response.success) {
                                alert(response.message);
                                location.reload();
                            } else {
                                alert(response.message);
                            }
                        }
                    });
                }
            });
        });
    </script>
}