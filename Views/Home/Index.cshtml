@model u22710362_HW03.Models.HomeViewModel

@{
    ViewBag.Title = "Home - Bike Store Management";
}

<div class="container mt-4">
    <h1 class="text-center mb-4">Bike Store Management System</h1>

    <!-- Staff Section -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h3 class="mb-0">Staff Members</h3>
                    <button type="button" class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#createStaffModal">
                        <i class="fas fa-plus"></i> Add New Staff
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Store</th>
                                    <th>Active</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var staff in Model.Staffs)
                                {
                                    <tr>
                                        <td>@staff.first_name @staff.last_name</td>
                                        <td>@staff.email</td>
                                        <td>@staff.phone</td>
                                        <td>@staff.stores?.store_name</td>
                                        <td>@(staff.active == 1 ? "Yes" : "No")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Customers Section -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h3 class="mb-0">Customers</h3>
                    <button type="button" class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#createCustomerModal">
                        <i class="fas fa-plus"></i> Add New Customer
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>City</th>
                                    <th>State</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var customer in Model.Customers)
                                {
                                    <tr>
                                        <td>@customer.first_name @customer.last_name</td>
                                        <td>@customer.email</td>
                                        <td>@customer.phone</td>
                                        <td>@customer.city</td>
                                        <td>@customer.state</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Products Section -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h3 class="mb-3">Products (Bicycles)</h3>
                    <div class="row">
                        <div class="col-md-5">
                            <label for="brandFilter" class="form-label">Filter by Brand:</label>
                            <select id="brandFilter" class="form-select">
                                <option value="">All Brands</option>
                                @foreach (var brand in ViewBag.Brands)
                                {
                                    <option value="@brand.brand_id">@brand.brand_name</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-5">
                            <label for="categoryFilter" class="form-label">Filter by Category:</label>
                            <select id="categoryFilter" class="form-select">
                                <option value="">All Categories</option>
                                @foreach (var category in ViewBag.Categories)
                                {
                                    <option value="@category.category_id">@category.category_name</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <button type="button" id="filterBtn" class="btn btn-light w-100">Filter</button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="productsTable">
                            <thead>
                                <tr>
                                    <th>Product Name</th>
                                    <th>Brand</th>
                                    <th>Category</th>
                                    <th>Model Year</th>
                                    <th>Price</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var product in Model.Products)
                                {
                                    <tr>
                                        <td>@product.product_name</td>
                                        <td>@product.brands?.brand_name</td>
                                        <td>@product.categories?.category_name</td>
                                        <td>@product.model_year</td>
                                        <td>$@product.list_price</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Staff Modal -->
<div class="modal fade" id="createStaffModal" tabindex="-1" aria-labelledby="createStaffModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createStaffModalLabel">Add New Staff</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="createStaffForm">
                @Html.AntiForgeryToken()
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="staff_first_name" class="form-label">First Name</label>
                        <input type="text" class="form-control" id="staff_first_name" name="first_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="staff_last_name" class="form-label">Last Name</label>
                        <input type="text" class="form-control" id="staff_last_name" name="last_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="staff_email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="staff_email" name="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="staff_phone" class="form-label">Phone</label>
                        <input type="text" class="form-control" id="staff_phone" name="phone">
                    </div>
                    <div class="mb-3">
                        <label for="staff_active" class="form-label">Active</label>
                        <select class="form-select" id="staff_active" name="active" required>
                            <option value="1">Yes</option>
                            <option value="0">No</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="staff_store_id" class="form-label">Store</label>
                        <select class="form-select" id="staff_store_id" name="store_id" required>
                            @foreach (var store in ViewBag.Stores)
                            {
                                <option value="@store.store_id">@store.store_name</option>
                            }
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save Staff</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Create Customer Modal -->
<div class="modal fade" id="createCustomerModal" tabindex="-1" aria-labelledby="createCustomerModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createCustomerModalLabel">Add New Customer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="createCustomerForm">
                @Html.AntiForgeryToken()
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="customer_first_name" class="form-label">First Name</label>
                        <input type="text" class="form-control" id="customer_first_name" name="first_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="customer_last_name" class="form-label">Last Name</label>
                        <input type="text" class="form-control" id="customer_last_name" name="last_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="customer_email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="customer_email" name="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="customer_phone" class="form-label">Phone</label>
                        <input type="text" class="form-control" id="customer_phone" name="phone">
                    </div>
                    <div class="mb-3">
                        <label for="customer_street" class="form-label">Street</label>
                        <input type="text" class="form-control" id="customer_street" name="street">
                    </div>
                    <div class="mb-3">
                        <label for="customer_city" class="form-label">City</label>
                        <input type="text" class="form-control" id="customer_city" name="city">
                    </div>
                    <div class="mb-3">
                        <label for="customer_state" class="form-label">State</label>
                        <input type="text" class="form-control" id="customer_state" name="state">
                    </div>
                    <div class="mb-3">
                        <label for="customer_zip_code" class="form-label">Zip Code</label>
                        <input type="text" class="form-control" id="customer_zip_code" name="zip_code">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-success">Save Customer</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Create Staff Form Submit
            // Replace form submit handlers with better error handling
$('#createStaffForm').submit(function (e) {
    e.preventDefault();

    // Disable submit button to prevent double submission
    var submitBtn = $(this).find('button[type="submit"]');
    submitBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Saving...');

    $.ajax({
        url: '@Url.Action("CreateStaff", "Home")',
        type: 'POST',
        data: $(this).serialize(),
        success: function (response) {
            if (response.success) {
                alert('Staff created successfully!');
                $('#createStaffModal').modal('hide');
                location.reload();
            } else {
                alert('Failed to create staff. Please check all required fields.');
                submitBtn.prop('disabled', false).html('Save Staff');
            }
        },
        error: function() {
            alert('An error occurred. Please try again.');
            submitBtn.prop('disabled', false).html('Save Staff');
        }
    });
});

            // Create Customer Form Submit
            $('#createCustomerForm').submit(function (e) {
                e.preventDefault();
                $.ajax({
                    url: '@Url.Action("CreateCustomer", "Home")',
                    type: 'POST',
                    data: $(this).serialize(),
                    success: function (response) {
                        if (response.success) {
                            alert('Customer created successfully!');
                            location.reload();
                        } else {
                            alert('Failed to create customer.');
                        }
                    }
                });
            });

            // Filter Products
            $('#filterBtn').click(function () {
    var brandId = $('#brandFilter').val();
    var categoryId = $('#categoryFilter').val();

    // Show loading indicator
    var tbody = $('#productsTable tbody');
    tbody.html('<tr><td colspan="5" class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>');

    $.ajax({
        url: '@Url.Action("FilterProducts", "Home")',
        type: 'GET',
        data: { brandId: brandId, categoryId: categoryId },
        success: function (data) {
            tbody.empty();

            if (data.length === 0) {
                tbody.append('<tr><td colspan="5" class="text-center">No products found</td></tr>');
            } else {
                $.each(data, function (i, product) {
                    var row = '<tr>' +
                        '<td>' + product.product_name + '</td>' +
                        '<td>' + product.brand_name + '</td>' +
                        '<td>' + product.category_name + '</td>' +
                        '<td>' + product.model_year + '</td>' +
                        '<td>$' + product.list_price.toFixed(2) + '</td>' +
                        '</tr>';
                    tbody.append(row);
                });
            }
        },
        error: function(xhr, status, error) {
            tbody.html('<tr><td colspan="5" class="text-center text-danger">Error loading products. Please try again.</td></tr>');
            console.error('Error:', error);
        }
    });
});
        });
    </script>
}